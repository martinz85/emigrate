---
description: Supabase Database Configuration for Emigrate Project
globs:
  - "auswanderer-app/supabase/**"
  - "auswanderer-app/src/lib/supabase/**"
  - "auswanderer-app/src/app/api/**"
  - "auswanderer-app/src/app/(auth)/**"
  - "auswanderer-app/src/app/auth/**"
alwaysApply: false
---

# Supabase Configuration - Emigrate Project

## âš ï¸ WICHTIG: IMMER ZUERST AUF DEV ARBEITEN!

**Alle Agents MÃœSSEN:**
1. Immer zuerst auf **Emigrate_DEV** entwickeln und testen
2. NIEMALS direkt auf PROD deployen ohne vorherigen DEV-Test
3. Bei DatenbankÃ¤nderungen: Zuerst Migration auf DEV, dann nach Review auf PROD

---

## Aktive Umgebungen

| Umgebung | Projekt | Status |
|----------|---------|--------|
| **DEV** | Emigrate_DEV | âœ… Standard fÃ¼r Entwicklung |
| **PROD** | Emigrate | ğŸ”’ Nur nach DEV-Test |

**Lokale `.env.local` zeigt auf: DEV (Emigrate_DEV)**

---

## DEV Environment (Emigrate_DEV) - STANDARD

| Key | Value |
|-----|-------|
| Project Reference | `hkktofxvgrxfkaixcowm` |
| Project URL | `https://hkktofxvgrxfkaixcowm.supabase.co` |
| Dashboard | https://supabase.com/dashboard/project/hkktofxvgrxfkaixcowm |
| SQL Editor | https://supabase.com/dashboard/project/hkktofxvgrxfkaixcowm/sql/new |

**API Keys (DEV):**
```
NEXT_PUBLIC_SUPABASE_URL=https://hkktofxvgrxfkaixcowm.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhra3RvZnh2Z3J4ZmthaXhjb3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDI0MjIsImV4cCI6MjA4NDM3ODQyMn0.cZ-HNWr09HihiHXsDIEXbCfLlGPYAQVC18SAl5pQZYY
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhra3RvZnh2Z3J4ZmthaXhjb3dtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODgwMjQyMiwiZXhwIjoyMDg0Mzc4NDIyfQ.fMWxkaaeNmybN86Fq-vKpxyyZSzO_iwmzD_e783jZH4
```

**CLI fÃ¼r DEV:**
```bash
cd auswanderer-app
export SUPABASE_ACCESS_TOKEN='sbp_77dfca3de7fe63a612a1a1d160d1f60acc272e37'
npx supabase link --project-ref hkktofxvgrxfkaixcowm
npx supabase db push
```

**Admin Password Script:**
```bash
cd auswanderer-app
SUPABASE_SERVICE_ROLE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhra3RvZnh2Z3J4ZmthaXhjb3dtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODgwMjQyMiwiZXhwIjoyMDg0Mzc4NDIyfQ.fMWxkaaeNmybN86Fq-vKpxyyZSzO_iwmzD_e783jZH4' node scripts/set-admin-password.mjs <email> <password>
```

---

## PROD Environment (Emigrate) - NUR NACH DEV-TEST

| Key | Value |
|-----|-------|
| Project Reference | `kfcofscgtvootvsnneux` |
| Project URL | `https://kfcofscgtvootvsnneux.supabase.co` |
| Dashboard | https://supabase.com/dashboard/project/kfcofscgtvootvsnneux |

**CLI fÃ¼r PROD (nur nach erfolgreichem DEV-Test!):**
```bash
cd auswanderer-app
export SUPABASE_ACCESS_TOKEN='sbp_77dfca3de7fe63a612a1a1d160d1f60acc272e37'
npx supabase link --project-ref kfcofscgtvootvsnneux
npx supabase db push
```

---

## Agent-Instruktionen

### FÃ¼r ALLE Agents

1. **Datenbank-Ã„nderungen**: Immer zuerst auf DEV testen
2. **App starten**: `npm run dev` verwendet automatisch DEV
3. **Browser-Tests**: Gegen `localhost:3000` (DEV-Datenbank)
4. **Migrations**: Zuerst auf DEV deployen, User informieren fÃ¼r PROD-Deploy

### FÃ¼r Dev Agent

- Bei Schema-Ã„nderungen: Neue Migration-Datei in `supabase/migrations/`
- Nach Migration: `npx supabase link --project-ref hkktofxvgrxfkaixcowm && npx supabase db push`
- Am Ende der Story: User fragen ob PROD-Deploy gewÃ¼nscht

### FÃ¼r SM Agent (Scrum Master)

- DatenbankÃ¤nderungen als Akzeptanzkriterium dokumentieren
- Hinweis in Story: "Migration zuerst auf DEV testen"

### FÃ¼r Max (Legal Agent)

- DSGVO: `deleted_at` Soft-Delete in `profiles` Tabelle
- Alle sensiblen Daten haben RLS aktiviert

---

## Workflow: DEV â†’ PROD

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ENTWICKLUNG (DEV)                                   â”‚
â”‚     - npm run dev                                       â”‚
â”‚     - .env.local â†’ Emigrate_DEV                         â”‚
â”‚     - Alle Tests hier!                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. MIGRATION AUF DEV                                   â”‚
â”‚     - npx supabase link --project-ref hkktofxvgrxfkaixcowm â”‚
â”‚     - npx supabase db push                              â”‚
â”‚     - Funktioniert? â†’ Weiter                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. CODE REVIEW                                         â”‚
â”‚     - Alle Features getestet?                           â”‚
â”‚     - SicherheitsprÃ¼fung?                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. PROD DEPLOY (Nur nach Freigabe!)                    â”‚
â”‚     - npx supabase link --project-ref kfcofscgtvootvsnneux â”‚
â”‚     - npx supabase db push                              â”‚
â”‚     - Vercel Deploy (PROD Env-Vars)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Env-Dateien

| Datei | Zweck | Supabase |
|-------|-------|----------|
| `.env.local` | Aktive lokale Umgebung | **DEV** |
| `.env.development.local` | DEV-Config Backup | DEV |
| `.env.production.local` | PROD-Config (nicht aktiv lokal) | PROD |

**Um temporÃ¤r mit PROD zu arbeiten:**
```bash
# VORSICHT - nur wenn nÃ¶tig!
cp .env.production.local .env.local

# ZurÃ¼ck zu DEV:
cp .env.development.local .env.local
```

---

## Database Schema

### Tabellen (identisch auf DEV und PROD)

| Tabelle | Beschreibung |
|---------|--------------|
| `profiles` | User-Profile |
| `analyses` | Analyse-Daten |
| `admin_users` | Admin-Rollen |
| `discount_codes` | Rabattcodes |
| `newsletter_subscribers` | Newsletter |

### Migrations

```
auswanderer-app/supabase/migrations/
â”œâ”€â”€ 001_initial_schema.sql
â””â”€â”€ 002_fix_rls_policies.sql
```

---

## Code-Verwendung

```typescript
// Client-side (Browser)
import { createClient } from '@/lib/supabase/client'
const supabase = createClient()

// Server-side (API Routes, Server Components)
import { createClient } from '@/lib/supabase/server'
const supabase = await createClient()

// Admin (bypasses RLS)
import { createAdminClient } from '@/lib/supabase/server'
const supabase = createAdminClient()
```

---

## CLI Access Token

```
SUPABASE_ACCESS_TOKEN=sbp_77dfca3de7fe63a612a1a1d160d1f60acc272e37
```

GÃ¼ltig bis: ~2026-02-18
Neuen Token: https://supabase.com/dashboard/account/tokens
